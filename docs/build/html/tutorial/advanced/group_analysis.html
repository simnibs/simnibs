
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Group Analysis &#8212; SimNIBS 3.2.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="TDCS Network Optimization" href="tdcs_distributed_opt.html" />
    <link rel="prev" title="Advanced Features" href="advanced.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="advanced.html" title="Previous document">Advanced Features</a>
        </li>
        <li>
          <a href="tdcs_distributed_opt.html" title="Next document">TDCS Network Optimization</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <div class="section" id="group-analysis">
<span id="group-tutorial"></span><h1>Group Analysis<a class="headerlink" href="#group-analysis" title="Permalink to this headline">¶</a></h1>
<p>SimNIBS supports group analysis of electric fields in both <em>FsAverage</em> and <em>MNI</em> spaces.</p>
<p>In this example, we will simulate the average electric field for a simple tDCS montage across five subjects using the <em>FsAverage</em> space.</p>
<div class="section" id="example-dataset">
<h2>Example Dataset<a class="headerlink" href="#example-dataset" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://osf.io/egshq/download">Click here to download the example dataset for group analyses</a>.</p>
<p>This example dataset is composed of a subgroup of a cohort available at <a class="reference external" href="https://openneuro.org/datasets/ds000171">OpenfMRI</a>. The data was processed in SimNIBS 2.1 using <a class="reference internal" href="../../documentation/command_line/headreco.html#headreco-docs"><span class="std std-ref">headreco</span></a>. For more information, please see the <a class="reference external" href="https://osf.io/ah5eu/">OSF repository</a> and <a class="reference external" href="https://doi.org/10.1101/500314">Saturnino et al., 2018</a>.</p>
<p>In this example, we have five subjects, named <code class="file docutils literal notranslate"><span class="pre">sub01</span></code>, <code class="file docutils literal notranslate"><span class="pre">sub09</span></code>,
<code class="file docutils literal notranslate"><span class="pre">sub10</span></code>, <code class="file docutils literal notranslate"><span class="pre">sub12</span></code>, and <code class="file docutils literal notranslate"><span class="pre">sub15</span></code>.</p>
</div>
<div class="section" id="objective">
<h2>Objective<a class="headerlink" href="#objective" title="Permalink to this headline">¶</a></h2>
<p>Suppose we apply tDCS on the five subjects using an anode over C3 and a cathode over AF4.
We want to obtain the mean and standard deviation of the normal component of the electric field (that is, the incoming or outgoing electric field component) in the middle gray matter surface across all subjects.</p>
<div class="figure align-default" id="id3">
<img alt="../../_images/tutorial_normal1.png" src="../../_images/tutorial_normal1.png" />
<p class="caption"><span class="caption-text">Norm (top) and Norma (bottom) of the electric field, from <a class="reference external" href="https://doi.org/10.1016/j.brs.2019.03.072">Antonenko et al. 2019</a></span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p></p>
</div>
<div class="section" id="set-up-and-run-simulations">
<h2>Set up and Run Simulations<a class="headerlink" href="#set-up-and-run-simulations" title="Permalink to this headline">¶</a></h2>
<p>There are several ways to set-up and run Simulations in SimNIBS</p>
<div class="section" id="gui">
<h3>GUI<a class="headerlink" href="#gui" title="Permalink to this headline">¶</a></h3>
<p>Set-up the simulation for each subject in the <a class="reference internal" href="../gui.html#gui-tutorial"><span class="std std-ref">Graphical User Interface</span></a>. In this case, remember to tick the <em>Transform to FsAverage</em> option in the <a class="reference internal" href="../../documentation/gui.html#sim-opt"><span class="std std-ref">Simulation Options Window</span></a>. (under <em>Edit</em> -&gt; <em>Simulation Options</em>)</p>
</div>
<div class="section" id="python">
<h3>Python<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h3>
<p>Write a <em>Python</em> script. In this case, remember to set <em>map_to_fsavg</em> to <em>True</em> in the <a class="reference internal" href="../../documentation/sim_struct/session.html#session-doc"><span class="std std-ref">SESSION</span></a> structure. See <a class="reference internal" href="../scripting.html#scripting-tutorial"><span class="std std-ref">Scripting Simulations</span></a> for more information.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This example runs tDCS simulations with a bipolar montage for five subjects</span>
<span class="sd">    The dataset with the five head models is avaliable at https://osf.io/ah5eu/</span>
<span class="sd">    please look at the &quot;group_average&quot; for how to do a simple analysis of the group data</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">simnibs</span> <span class="kn">import</span> <span class="n">sim_struct</span><span class="p">,</span> <span class="n">run_simnibs</span>

<span class="c1"># Set the subjects</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sub01&#39;</span><span class="p">,</span> <span class="s1">&#39;sub09&#39;</span><span class="p">,</span> <span class="s1">&#39;sub10&#39;</span><span class="p">,</span> <span class="s1">&#39;sub12&#39;</span><span class="p">,</span> <span class="s1">&#39;sub15&#39;</span><span class="p">]</span>

<span class="c1"># Set a TDCSLIST structure with the simulation set-up</span>
<span class="n">tdcslist</span> <span class="o">=</span> <span class="n">sim_struct</span><span class="o">.</span><span class="n">TDCSLIST</span><span class="p">()</span>
<span class="n">tdcslist</span><span class="o">.</span><span class="n">currents</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">]</span>

<span class="n">anode</span> <span class="o">=</span> <span class="n">tdcslist</span><span class="o">.</span><span class="n">add_electrode</span><span class="p">()</span>
<span class="n">anode</span><span class="o">.</span><span class="n">channelnr</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">anode</span><span class="o">.</span><span class="n">centre</span> <span class="o">=</span> <span class="s1">&#39;C3&#39;</span>
<span class="n">anode</span><span class="o">.</span><span class="n">pos_ydir</span> <span class="o">=</span> <span class="s1">&#39;C1&#39;</span>
<span class="n">anode</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="s1">&#39;rect&#39;</span>
<span class="n">anode</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">anode</span><span class="o">.</span><span class="n">thickness</span> <span class="o">=</span> <span class="mi">4</span>


<span class="n">cathode</span> <span class="o">=</span> <span class="n">tdcslist</span><span class="o">.</span><span class="n">add_electrode</span><span class="p">()</span>
<span class="n">cathode</span><span class="o">.</span><span class="n">channelnr</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">cathode</span><span class="o">.</span><span class="n">centre</span> <span class="o">=</span> <span class="s1">&#39;AF4&#39;</span>
<span class="n">cathode</span><span class="o">.</span><span class="n">pos_ydir</span> <span class="o">=</span> <span class="s1">&#39;F6&#39;</span>
<span class="n">cathode</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="s1">&#39;rect&#39;</span>
<span class="n">cathode</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">70</span><span class="p">]</span>
<span class="n">cathode</span><span class="o">.</span><span class="n">thickness</span> <span class="o">=</span> <span class="mi">4</span>


<span class="c1"># Run the simulation in each subject</span>
<span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
    <span class="c1"># ALWAYS create a new SESSION when changing subjects</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">sim_struct</span><span class="o">.</span><span class="n">SESSION</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">map_to_fsavg</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">s</span><span class="o">.</span><span class="n">map_to_MNI</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">s</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;eEjJ&#39;</span>
    <span class="n">s</span><span class="o">.</span><span class="n">fnamehead</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">sub</span> <span class="o">+</span> <span class="s1">&#39;.msh&#39;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">pathfem</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s1">&#39;bipolar&#39;</span><span class="p">)</span>
    <span class="c1"># Don&#39;t open in gmsh</span>
    <span class="n">s</span><span class="o">.</span><span class="n">open_in_gmsh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Add the tdcslist we defined above</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add_poslist</span><span class="p">(</span><span class="n">tdcslist</span><span class="p">)</span>
    <span class="c1"># Run the sumulation</span>
    <span class="n">run_simnibs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="matlab">
<h3>MATLAB<a class="headerlink" href="#matlab" title="Permalink to this headline">¶</a></h3>
<p>Write a <em>MATLAB</em> script. In this case, remember to set <em>map_to_fsavg</em> to <em>True</em> in the <a class="reference internal" href="../../documentation/sim_struct/session.html#session-doc"><span class="std std-ref">SESSION</span></a> structure. See <a class="reference internal" href="../scripting.html#scripting-tutorial"><span class="std std-ref">Scripting Simulations</span></a> for more information.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">%  This example runs tDCS simulations with a bipolar montage for five subjects</span>
<span class="c">%  The dataset with the five head models is avaliable at https://osf.io/ah5eu/</span>
<span class="c">%  please look at the &quot;group_average&quot; for how to do a simple analysis of the group data</span>

<span class="c">% Set the subjects</span>
<span class="n">subjects</span> <span class="p">=</span> <span class="p">{</span><span class="s">&#39;sub01&#39;</span><span class="p">,</span> <span class="s">&#39;sub09&#39;</span><span class="p">,</span> <span class="s">&#39;sub10&#39;</span><span class="p">,</span> <span class="s">&#39;sub12&#39;</span><span class="p">,</span> <span class="s">&#39;sub15&#39;</span><span class="p">};</span>

<span class="c">% Start a SESSION</span>
<span class="n">S</span> <span class="p">=</span> <span class="n">sim_struct</span><span class="p">(</span><span class="s">&#39;SESSION&#39;</span><span class="p">);</span>
<span class="n">S</span><span class="p">.</span><span class="n">map_to_fsavg</span> <span class="p">=</span> <span class="n">true</span><span class="p">;</span>
<span class="n">S</span><span class="p">.</span><span class="n">map_to_mni</span> <span class="p">=</span> <span class="n">true</span><span class="p">;</span>
<span class="n">S</span><span class="p">.</span><span class="n">fields</span> <span class="p">=</span> <span class="s">&#39;eEjJ&#39;</span><span class="p">;</span>

<span class="c">% Set a TDCSLIST with the simulation set-up</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span> <span class="p">=</span> <span class="n">sim_struct</span><span class="p">(</span><span class="s">&#39;TDCSLIST&#39;</span><span class="p">);</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">currents</span> <span class="p">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">];</span>

<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">channelnr</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">centre</span> <span class="p">=</span> <span class="s">&#39;C3&#39;</span><span class="p">;</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">pos_ydir</span> <span class="p">=</span> <span class="s">&#39;C1&#39;</span><span class="p">;</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">shape</span> <span class="p">=</span> <span class="s">&#39;rect&#39;</span><span class="p">;</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">dimensions</span> <span class="p">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">];</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">thickness</span> <span class="p">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">channelnr</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">centre</span> <span class="p">=</span> <span class="s">&#39;AF4&#39;</span><span class="p">;</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">pos_ydir</span> <span class="p">=</span> <span class="s">&#39;F6&#39;</span><span class="p">;</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">shape</span> <span class="p">=</span> <span class="s">&#39;rect&#39;</span><span class="p">;</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">dimensions</span> <span class="p">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">70</span><span class="p">];</span>
<span class="n">S</span><span class="p">.</span><span class="n">poslist</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">electrode</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">thickness</span> <span class="p">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="c">% Run the simulation in each subject</span>
<span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>
     <span class="n">sub</span> <span class="p">=</span> <span class="n">subjects</span><span class="p">{</span><span class="nb">i</span><span class="p">};</span>
     <span class="n">S</span><span class="p">.</span><span class="n">fnamehead</span> <span class="p">=</span> <span class="n">fullfile</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="p">[</span><span class="n">sub</span> <span class="s">&#39;.msh&#39;</span><span class="p">]);</span>  <span class="c">% head mesh</span>
     <span class="n">S</span><span class="p">.</span><span class="n">pathfem</span> <span class="p">=</span> <span class="n">fullfile</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s">&#39;bipolar&#39;</span><span class="p">);</span> <span class="c">% Output directory</span>
     <span class="n">run_simnibs</span><span class="p">(</span><span class="n">S</span><span class="p">);</span><span class="n"></span>
<span class="n">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="calculate-mean">
<h2>Calculate Mean<a class="headerlink" href="#calculate-mean" title="Permalink to this headline">¶</a></h2>
<p>When the simulations are over, we need to collect their results to calculate an average. In SimNIBS, we can do it either in Python or MATLAB.
Please notice that, while for setting up simulations Python and MATLAB share a similar interface, in post-processing the interfaces can be very different.</p>
<div class="section" id="id1">
<h3>Python<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This example wil go throgh simulations and calculate</span>
<span class="sd">    the average and the standard deviation of the normal component</span>
<span class="sd">    of the electric field in FsAverage space</span>

<span class="sd">    It is a follow-up to the &quot;run_simulations&quot; example</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">simnibs</span>

<span class="c1">## Load simulation results</span>
<span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sub01&#39;</span><span class="p">,</span> <span class="s1">&#39;sub09&#39;</span><span class="p">,</span> <span class="s1">&#39;sub10&#39;</span><span class="p">,</span> <span class="s1">&#39;sub12&#39;</span><span class="p">,</span> <span class="s1">&#39;sub15&#39;</span><span class="p">]</span>
<span class="n">results_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;bipolar&#39;</span><span class="p">,</span> <span class="s1">&#39;fsavg_overlays&#39;</span><span class="p">)</span>
<span class="n">fsavg_msh_name</span> <span class="o">=</span> <span class="s1">&#39;_TDCS_1_scalar_fsavg.msh&#39;</span>
<span class="n">field_name</span> <span class="o">=</span> <span class="s1">&#39;E_normal&#39;</span>

<span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
    <span class="c1"># read mesh with results transformed to fsaverage space</span>
    <span class="n">results_fsavg</span> <span class="o">=</span> <span class="n">simnibs</span><span class="o">.</span><span class="n">read_msh</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">results_folder</span><span class="p">,</span> <span class="n">sub</span> <span class="o">+</span> <span class="n">fsavg_msh_name</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># save the field in each subject</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results_fsavg</span><span class="o">.</span><span class="n">field</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="c1">## Calculate and plot averages</span>
<span class="c1"># Calculate</span>
<span class="n">fields</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
<span class="n">avg_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">std_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Plot</span>
<span class="n">results_fsavg</span><span class="o">.</span><span class="n">nodedata</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># cleanup fields</span>
<span class="n">results_fsavg</span><span class="o">.</span><span class="n">add_node_field</span><span class="p">(</span><span class="n">avg_field</span><span class="p">,</span> <span class="s1">&#39;E_normal_avg&#39;</span><span class="p">)</span> <span class="c1"># add average field</span>
<span class="n">results_fsavg</span><span class="o">.</span><span class="n">add_node_field</span><span class="p">(</span><span class="n">std_field</span><span class="p">,</span> <span class="s1">&#39;E_normal_std&#39;</span><span class="p">)</span> <span class="c1"># add std field</span>

<span class="c1"># show surface with the fields</span>
<span class="n">results_fsavg</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">visible_fields</span><span class="o">=</span><span class="s1">&#39;E_normal_avg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">## Calculate average in an ROI defined using an atlas</span>
<span class="c1"># load atlas and define a region</span>
<span class="n">atlas</span> <span class="o">=</span> <span class="n">simnibs</span><span class="o">.</span><span class="n">get_atlas</span><span class="p">(</span><span class="s1">&#39;HCP_MMP1&#39;</span><span class="p">)</span>
<span class="n">region_name</span> <span class="o">=</span> <span class="s1">&#39;lh.4&#39;</span>
<span class="n">roi</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span>
<span class="c1"># visualize region</span>
<span class="n">results_fsavg</span><span class="o">.</span><span class="n">add_node_field</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">region_name</span><span class="p">)</span>
<span class="n">results_fsavg</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">visible_fields</span><span class="o">=</span><span class="n">region_name</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># calculate mean field using a weighted mean</span>
<span class="n">node_areas</span> <span class="o">=</span> <span class="n">results_fsavg</span><span class="o">.</span><span class="n">nodes_areas</span><span class="p">()</span>
<span class="n">avg_field_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">avg_field</span><span class="p">[</span><span class="n">roi</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">node_areas</span><span class="p">[</span><span class="n">roi</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average </span><span class="si">{field_name}</span><span class="s1"> in </span><span class="si">{region_name}</span><span class="s1">: &#39;</span><span class="p">,</span> <span class="n">avg_field_roi</span><span class="p">)</span>
<span class="n">results_fsavg</span><span class="o">.</span><span class="n">add_node_field</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">region_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>MATLAB<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% This example wil go throgh simulations and calculate</span>
<span class="c">% the average and the standard deviation of the normal component</span>
<span class="c">% of the electric field in FsAverage space</span>
<span class="c">% </span>
<span class="c">% It is a follow-up to the &quot;run_simulations&quot; example</span>

<span class="c">%% Load simulation results</span>
<span class="n">subjects</span> <span class="p">=</span> <span class="p">{</span><span class="s">&#39;sub01&#39;</span><span class="p">,</span> <span class="s">&#39;sub09&#39;</span><span class="p">,</span> <span class="s">&#39;sub10&#39;</span><span class="p">,</span> <span class="s">&#39;sub12&#39;</span><span class="p">,</span> <span class="s">&#39;sub15&#39;</span><span class="p">};</span>
<span class="n">results_folder</span> <span class="p">=</span> <span class="n">fullfile</span><span class="p">(</span><span class="s">&#39;bipolar&#39;</span><span class="p">,</span> <span class="s">&#39;fsavg_overlays&#39;</span><span class="p">);</span>
<span class="n">fsavg_msh_name</span> <span class="p">=</span> <span class="s">&#39;_TDCS_1_scalar_fsavg.msh&#39;</span><span class="p">;</span>
<span class="n">field_name</span> <span class="p">=</span> <span class="s">&#39;E_normal&#39;</span><span class="p">;</span>

<span class="n">fields</span> <span class="p">=</span> <span class="p">{};</span><span class="n"></span>
<span class="n">for </span><span class="s">i = 1:length(subjects)</span><span class="p"></span>
    <span class="n">sub</span> <span class="p">=</span> <span class="n">subjects</span><span class="p">{</span><span class="nb">i</span><span class="p">};</span>
    <span class="c">% load mesh with results transformed to fsaverage space</span>
    <span class="n">m</span> <span class="p">=</span> <span class="n">mesh_load_gmsh4</span><span class="p">(</span><span class="n">fullfile</span><span class="p">(</span><span class="n">pwd</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">results_folder</span><span class="p">,</span> <span class="p">[</span><span class="n">sub</span> <span class="n">fsavg_msh_name</span><span class="p">]));</span>
    <span class="c">% Save the field of each subject</span>
    <span class="n">fields</span><span class="p">{</span><span class="nb">i</span><span class="p">}</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="n">node_data</span><span class="p">{</span><span class="n">get_field_idx</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="s">&#39;node&#39;</span><span class="p">)}.</span><span class="n">data</span><span class="p">;</span><span class="n"></span>
<span class="n">end</span>
<span class="s">%% Calculate and plot averages</span><span class="p"></span>
<span class="c">% Calculate</span>
<span class="n">fields</span> <span class="p">=</span> <span class="n">cell2mat</span><span class="p">(</span><span class="n">fields</span><span class="p">);</span>
<span class="n">avg_field</span> <span class="p">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">std_field</span> <span class="p">=</span> <span class="n">std</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="c">% Plot</span>
<span class="n">m</span><span class="p">.</span><span class="n">node_data</span> <span class="p">=</span> <span class="p">{};</span> <span class="c">%cleanup fields</span>
<span class="n">m</span><span class="p">.</span><span class="n">node_data</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">data</span> <span class="p">=</span> <span class="n">avg_field</span><span class="p">;</span> <span class="c">% add average field</span>
<span class="n">m</span><span class="p">.</span><span class="n">node_data</span><span class="p">{</span><span class="mi">1</span><span class="p">}.</span><span class="n">name</span> <span class="p">=</span> <span class="p">[</span><span class="n">field_name</span> <span class="s">&#39;_avg&#39;</span><span class="p">];</span>
<span class="n">m</span><span class="p">.</span><span class="n">node_data</span><span class="p">{</span><span class="mi">2</span><span class="p">}.</span><span class="n">data</span> <span class="p">=</span> <span class="n">std_field</span><span class="p">;</span> <span class="c">% add std field</span>
<span class="n">m</span><span class="p">.</span><span class="n">node_data</span><span class="p">{</span><span class="mi">2</span><span class="p">}.</span><span class="n">name</span> <span class="p">=</span> <span class="p">[</span><span class="n">field_name</span> <span class="s">&#39;_std&#39;</span><span class="p">];</span>

<span class="c">% show surfaces with fields</span>
<span class="n">mesh_show_surface</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&#39;field_idx&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">field_name</span> <span class="s">&#39;_avg&#39;</span><span class="p">])</span>
<span class="n">mesh_show_surface</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&#39;field_idx&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">field_name</span> <span class="s">&#39;_std&#39;</span><span class="p">])</span>

<span class="c">%% Calculate average in an ROI defined using an atlas</span>
<span class="c">% load atlas and define a region</span>
<span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">snames</span><span class="p">]=</span><span class="n">mesh_load_fssurf</span><span class="p">(</span><span class="s">&#39;fsaverage&#39;</span><span class="p">,</span><span class="s">&#39;label&#39;</span><span class="p">,</span><span class="s">&#39;HCP_MMP1&#39;</span><span class="p">);</span>
<span class="n">region_name</span> <span class="p">=</span> <span class="s">&#39;lh.4&#39;</span><span class="p">;</span>
<span class="n">roi_idx</span><span class="p">=</span><span class="nb">find</span><span class="p">(</span><span class="n">strcmpi</span><span class="p">(</span><span class="n">snames</span><span class="p">,</span> <span class="n">region_name</span><span class="p">));</span>
<span class="n">node_idx</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="n">node_data</span><span class="p">{</span><span class="k">end</span><span class="p">}.</span><span class="n">data</span><span class="o">==</span><span class="n">roi_idx</span><span class="p">;</span>
<span class="c">% visualize region</span>
<span class="n">m</span><span class="p">.</span><span class="n">node_data</span><span class="p">{</span><span class="k">end</span><span class="o">+</span><span class="mi">1</span><span class="p">}.</span><span class="n">data</span> <span class="p">=</span> <span class="n">int8</span><span class="p">(</span><span class="n">node_idx</span><span class="p">);</span>
<span class="n">m</span><span class="p">.</span><span class="n">node_data</span><span class="p">{</span><span class="k">end</span><span class="p">}.</span><span class="n">name</span> <span class="p">=</span> <span class="n">region_name</span><span class="p">;</span>
<span class="n">mesh_show_surface</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&#39;field_idx&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="p">)</span>

<span class="c">% calculate a weighted mean using the node areas</span>
<span class="n">nodes_areas</span> <span class="p">=</span> <span class="n">mesh_get_node_areas</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="n">avg_field_roi</span> <span class="p">=</span> <span class="n">sum</span><span class="p">(</span><span class="n">avg_field</span><span class="p">(</span><span class="n">node_idx</span><span class="p">)</span><span class="o">.*</span><span class="n">nodes_areas</span><span class="p">(</span><span class="n">node_idx</span><span class="p">))</span><span class="o">/</span><span class="n">sum</span><span class="p">(</span><span class="n">nodes_areas</span><span class="p">(</span><span class="n">node_idx</span><span class="p">));</span>
<span class="n">fprintf</span><span class="p">(</span><span class="s">&#39;Average %s in %s: %f\n&#39;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="n">avg_field_roi</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h2>
<p>For more information on group analysis, please see our <a class="reference external" href="https://doi.org/10.1101/500314">SimNIBS 2.1 tutorial paper</a> and <a class="reference external" href="https://doi.org/10.1093/cercor/bhw292A">Bungert et al. 2017</a>.</p>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="advanced.html" title="Previous document">Advanced Features</a>
        </li>
        <li>
          <a href="tdcs_distributed_opt.html" title="Next document">TDCS Network Optimization</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataset.html">Example Dataset</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../gui.html">Setting up and Running Simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualization.html">Visualizing Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="../head_meshing.html">Creating Head Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scripting.html">Scripting Simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analysis.html">Analyzing Simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../optimization.html">TDCS Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tms_optimization.html">TMS Optimization</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="advanced.html">Advanced Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../win_prompt.html">Accessing the Command Prompt on Windows</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributors.html">Contributors and Funding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../tutorial.html">Tutorial</a><ul>
  <li><a href="advanced.html">Advanced Features</a><ul>
      <li>Previous: <a href="advanced.html" title="previous chapter">Advanced Features</a></li>
      <li>Next: <a href="tdcs_distributed_opt.html" title="next chapter">TDCS Network Optimization</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, SimNIBS Developers.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/tutorial/advanced/group_analysis.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>